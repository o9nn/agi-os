services:
  # ------
  # Postgres section
  # ------
  postgres:
    image: postgres
    restart: always
    environment:
      POSTGRES_USER: deditor
      POSTGRES_PASSWORD: 123456
      POSTGRES_DB: test_deditor_db
    ports:
      - '7432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: [CMD-SHELL, pg_isready -d $$POSTGRES_DB -U $$POSTGRES_USER]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------
  # pgvector_rs section
  # ------
  pgvector_rs:
    image: ghcr.io/tensorchord/pgvecto-rs:pg17-v0.4.0
    ports:
      - '7433:5432'
    environment:
      POSTGRES_DATABASE: postgres
      POSTGRES_PASSWORD: '123456'
    volumes:
      - ./pgvector_rs/init.sql:/docker-entrypoint-initdb.d/init.sql
      - pgvector_rs_data:/var/lib/postgresql/data
    healthcheck:
      test: [CMD-SHELL, pg_isready -d $$POSTGRES_DB -U $$POSTGRES_USER]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------
  # pgvector section
  # ------
  pgvector:
    image: pgvector/pgvector:pg17
    ports:
      - '7434:5432'
    environment:
      POSTGRES_DATABASE: postgres
      POSTGRES_PASSWORD: '123456'
    volumes:
      - ./pgvector/init.sql:/docker-entrypoint-initdb.d/init.sql
      - pgvector_data:/var/lib/postgresql/data
    healthcheck:
      test: [CMD-SHELL, pg_isready -d $$POSTGRES_DB -U $$POSTGRES_USER]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------
  # MySQL section
  # ------
  mysql:
    image: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: test_deditor_db
      MYSQL_USER: deditor
      MYSQL_PASSWORD: 123456
    ports:
      - '7306:3306'
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: [CMD-SHELL, mysqladmin ping -h localhost -u root -p123456]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------
  # Redis section
  # ------
  redis_stack:
    image: redis/redis-stack-server:latest
    restart: unless-stopped
    ports:
      - 7379:6379

  # ------
  # Milvus section
  #
  # Originally from https://github.com/milvus-io/milvus/releases/download/v2.5.10/milvus-standalone-docker-compose.yml
  # Read more: https://milvus.io/docs/install_standalone-docker-compose.md
  # ------
  milvus_etcd:
    image: quay.io/coreos/etcd:v3.5.18
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - milvus_etcd_data:/volumes/etcd:/etcd
    command: etcd -advertise-client-urls=http://etcd:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: [CMD, etcdctl, endpoint, health]
      interval: 30s
      timeout: 20s
      retries: 3

  milvus_minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - '7001:9001'
      - '7000:9000'
    volumes:
      - milvus_minio_data:/volumes/minio:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: [CMD, curl, -f, 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3

  milvus:
    image: milvusdb/milvus:v2.5.10
    command: [milvus, run, standalone]
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: milvus_etcd:2379
      MINIO_ADDRESS: milvus_minio:9000
    volumes:
      - milvus_data:/volumes/milvus:/var/lib/milvus
    healthcheck:
      test: [CMD, curl, -f, 'http://localhost:9091/healthz']
      interval: 30s
      start_period: 90s
      timeout: 20s
      retries: 3
    ports:
      - '17530:19530'
      - '7091:9091'
    depends_on:
      - milvus_etcd
      - milvus_minio

volumes:
  postgres_data:
    driver: local
  pgvector_rs_data:
    driver: local
  pgvector_data:
    driver: local
  mysql_data:
    driver: local
  milvus_etcd_data:
    driver: local
  milvus_minio_data:
    driver: local
  milvus_data:
    driver: local
