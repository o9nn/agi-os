name: Guix Build CI

on:
  push:
    branches: ["main"]
    paths:
      - 'guix.scm'
      - '.guix/**'
      - 'packaging/**'
      - 'cogutil/**'
      - 'atomspace/**'
      - 'cogserver/**'
      - '.github/workflows/guix-build.yml'
  pull_request:
    branches: ["main"]
  workflow_dispatch:  # Allow manual triggering

jobs:
  guix-build:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Increased timeout for complex builds

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for faster checkout

      # Create a user-writable cache directory
      - name: Setup cache directories
        run: |
          mkdir -p $HOME/.cache/guix
          mkdir -p $HOME/.config/guix
          mkdir -p $HOME/guix-build-cache
          echo "GUIX_BUILD_CACHE=$HOME/guix-build-cache" >> $GITHUB_ENV

      # Cache Guix store with proper permissions
      - name: Cache Guix store
        id: cache-guix
        uses: actions/cache@v4
        with:
          path: |
            ~/guix-build-cache
            ~/.cache/guix
            ~/.config/guix
          key: guix-${{ runner.os }}-${{ hashFiles('guix.scm', '.guix/**/*.scm', 'packaging/*.scm') }}
          restore-keys: |
            guix-${{ runner.os }}-

      - name: Install GNU Guix non-interactively (SSR safe, local)
        if: steps.cache-guix.outputs.cache-hit != 'true'
        run: |
          # Record start time for metrics
          echo "INSTALL_START=$(date +%s)" >> $GITHUB_ENV
          
          # Execute the locally mirrored Guix installer (SSR best practice)
          # This eliminates network dependency and ensures reproducible builds
          # See tools/README.md for version information and update procedures
          printf '\n' | sudo bash tools/guix-install.sh
          
          # Record installation time
          INSTALL_END=$(date +%s)
          INSTALL_DURATION=$((INSTALL_END - ${INSTALL_START:-$INSTALL_END}))
          echo "INSTALL_DURATION=$INSTALL_DURATION" >> $GITHUB_ENV
          echo "Guix installation took $INSTALL_DURATION seconds"
          
      - name: Setup Guix environment
        run: |
          # Record start time
          echo "SETUP_START=$(date +%s)" >> $GITHUB_ENV
          
          # Configure Guix environment variables and add to GITHUB_ENV for subsequent steps
          GUIX_USER_PATH="/var/guix/profiles/per-user/$(whoami)/current-guix/bin"
          GUIX_PROFILE="/var/guix/profiles/per-user/$(whoami)/current-guix"
          
          # Add to GitHub Actions environment for all subsequent steps
          echo "$GUIX_USER_PATH" >> $GITHUB_PATH
          echo "GUIX_LOCPATH=$HOME/.guix-profile/lib/locale" >> $GITHUB_ENV
          echo "GUIX_PACKAGE_PATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "GUIX_PROFILE=$GUIX_PROFILE" >> $GITHUB_ENV
          echo "GUILE_LOAD_PATH=$GUIX_PROFILE/share/guile/site/3.0" >> $GITHUB_ENV
          echo "GUILE_LOAD_COMPILED_PATH=$GUIX_PROFILE/lib/guile/3.0/site-ccache" >> $GITHUB_ENV
          
          # Ensure guix daemon is running
          echo "Starting guix daemon..."
          if sudo systemctl start guix-daemon 2>/dev/null; then
            echo "âœ“ Daemon started via systemctl"
          else
            echo "systemctl failed, trying manual daemon start..."
            sudo /var/guix/profiles/per-user/root/current-guix/bin/guix-daemon \
              --build-users-group=guixbuild &
            sleep 5
            echo "âœ“ Daemon started manually"
          fi
          
          # Verify daemon is accessible
          echo "Verifying guix daemon..."
          if guix describe 2>/dev/null; then
            echo "âœ“ Guix daemon is accessible"
            guix describe
          else
            echo "Daemon not responding, attempting guix pull..."
            guix pull --fallback
            guix describe
          fi
          
          # Verify Guile is available
          echo "Verifying Guile installation..."
          if command -v guile &> /dev/null; then
            GUILE_VERSION=$(guile --version | head -1)
            echo "âœ“ Guile found: $GUILE_VERSION"
            echo "GUILE_VERSION=$GUILE_VERSION" >> $GITHUB_ENV
          else
            echo "âš  Guile not found in PATH, may affect validation steps"
          fi
          
          # Record setup time
          SETUP_END=$(date +%s)
          SETUP_DURATION=$((SETUP_END - ${SETUP_START:-$SETUP_END}))
          echo "SETUP_DURATION=$SETUP_DURATION" >> $GITHUB_ENV
          echo "Environment setup took $SETUP_DURATION seconds"
          
      - name: Verify Guix files
        run: |
          # Record start time
          echo "VERIFY_START=$(date +%s)" >> $GITHUB_ENV
          
          # Validate guix.scm syntax using guix repl
          echo "=== Validating Guix package definitions ==="
          
          # Test main guix.scm
          echo "Validating guix.scm syntax using guix repl..."
          if guix repl -- <<'EOF'
          (use-modules (guix packages))
          (with-input-from-file "guix.scm" 
            (lambda () 
              (let loop ((expr (read)))
                (unless (eof-object? expr)
                  (loop (read))))))
          (display "âœ“ guix.scm: Syntax OK\n")
          EOF
          then
            echo "âœ“ guix.scm validation passed"
          else
            echo "âœ— guix.scm syntax validation failed"
            exit 1
          fi
          
          # Test additional Guix files if they exist
          if [ -f ".guix/modules/opencog-package.scm" ]; then
            echo "Validating .guix/modules/opencog-package.scm..."
            if guix repl -- <<'EOF'
            (with-input-from-file ".guix/modules/opencog-package.scm" 
              (lambda () 
                (let loop ((expr (read)))
                  (unless (eof-object? expr)
                    (loop (read))))))
            (display "âœ“ opencog-package.scm: Syntax OK\n")
          EOF
            then
              echo "âœ“ opencog-package.scm validation passed"
            else
              echo "âš  opencog-package.scm syntax validation failed"
            fi
          fi
          
          # Record verification time
          VERIFY_END=$(date +%s)
          VERIFY_DURATION=$((VERIFY_END - ${VERIFY_START:-$VERIFY_END}))
          echo "VERIFY_DURATION=$VERIFY_DURATION" >> $GITHUB_ENV
          echo "Verification took $VERIFY_DURATION seconds"
          
      - name: Build with Guix (dry-run)
        run: |
          # Record start time
          echo "DRYRUN_START=$(date +%s)" >> $GITHUB_ENV
          
          # Dry-run to validate package definition without building
          echo "=== Running dry-run build to check package definition ==="
          if guix build -f guix.scm --dry-run --verbosity=2 2>&1 | tee dry-run.log; then
            echo "âœ“ Dry-run validation passed"
            
            # Extract derivation information
            if grep -q "would be built:" dry-run.log; then
              BUILD_COUNT=$(grep "would be built:" dry-run.log | grep -oP '\d+' | head -1)
              echo "BUILD_COUNT=$BUILD_COUNT" >> $GITHUB_ENV
              echo "â†’ $BUILD_COUNT derivations would be built"
            fi
            
            if grep -q "would be downloaded:" dry-run.log; then
              DOWNLOAD_COUNT=$(grep "would be downloaded:" dry-run.log | grep -oP '\d+' | head -1)
              echo "DOWNLOAD_COUNT=$DOWNLOAD_COUNT" >> $GITHUB_ENV
              echo "â†’ $DOWNLOAD_COUNT items would be downloaded"
            fi
          else
            echo "âœ— Dry-run failed, checking package syntax with guix repl..."
            guix repl -- <<'EOF'
            (use-modules (guix packages))
            (with-input-from-file "guix.scm" 
              (lambda () 
                (let loop ((expr (read)))
                  (unless (eof-object? expr)
                    (loop (read))))))
            (display "Package syntax check passed\n")
          EOF
            exit 1
          fi
          
          # Record dry-run time
          DRYRUN_END=$(date +%s)
          DRYRUN_DURATION=$((DRYRUN_END - ${DRYRUN_START:-$DRYRUN_END}))
          echo "DRYRUN_DURATION=$DRYRUN_DURATION" >> $GITHUB_ENV
          echo "Dry-run took $DRYRUN_DURATION seconds"
          
      - name: Build with Guix (actual build - may be slow)
        id: guix-build
        continue-on-error: true
        run: |
          # Record start time
          echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV
          
          echo "=== Attempting actual build ==="
          echo "Note: This may take a long time for complex packages"
          
          # Build with options to speed up the process:
          # --no-grafts: Skip grafting (security updates) for faster builds
          # --verbosity=1: Show progress without overwhelming logs
          # --cores=0: Use all available CPU cores
          # --max-jobs=4: Allow parallel job execution
          if guix build -f guix.scm --verbosity=1 --no-grafts --cores=0 --max-jobs=4 2>&1 | tee build-output.log; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
            
            # Store the build result path for artifact upload
            if [ -f build-output.log ]; then
              BUILD_RESULT=$(tail -1 build-output.log)
              echo "BUILD_RESULT=$BUILD_RESULT" >> $GITHUB_ENV
              echo "âœ“ Build completed successfully: $BUILD_RESULT"
              
              # Try to get build statistics
              if [ -d "$BUILD_RESULT" ]; then
                BUILD_SIZE=$(du -sh "$BUILD_RESULT" 2>/dev/null | cut -f1 || echo "unknown")
                echo "BUILD_SIZE=$BUILD_SIZE" >> $GITHUB_ENV
                echo "â†’ Build output size: $BUILD_SIZE"
              fi
            fi
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "âœ— Build failed - this is common for complex packages"
            echo "See build-output.log for details"
          fi
          
          # Record build time
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - ${BUILD_START:-$BUILD_END}))
          echo "BUILD_DURATION=$BUILD_DURATION" >> $GITHUB_ENV
          echo "Build attempt took $BUILD_DURATION seconds"
          
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: guix-build-logs
          path: |
            build-output.log
            dry-run.log
          retention-days: 7
          
      - name: Collect build metrics
        if: always()
        run: |
          # Create metrics report
          cat > build-metrics.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run": "${{ github.run_number }}",
            "cache_hit": "${{ steps.cache-guix.outputs.cache-hit }}",
            "install_duration": "${INSTALL_DURATION:-0}",
            "setup_duration": "${SETUP_DURATION:-0}",
            "verify_duration": "${VERIFY_DURATION:-0}",
            "dryrun_duration": "${DRYRUN_DURATION:-0}",
            "build_duration": "${BUILD_DURATION:-0}",
            "build_status": "${BUILD_STATUS:-unknown}",
            "build_count": "${BUILD_COUNT:-0}",
            "download_count": "${DOWNLOAD_COUNT:-0}",
            "build_size": "${BUILD_SIZE:-unknown}",
            "guile_version": "${GUILE_VERSION:-unknown}"
          }
          EOF
          
          echo "=== Build Metrics ==="
          cat build-metrics.json
          
      - name: Upload build metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-metrics
          path: build-metrics.json
          retention-days: 30
          
      - name: Build summary
        if: always()
        run: |
          # Calculate total time
          TOTAL_DURATION=$((${INSTALL_DURATION:-0} + ${SETUP_DURATION:-0} + ${VERIFY_DURATION:-0} + ${DRYRUN_DURATION:-0} + ${BUILD_DURATION:-0}))
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ”§ Guix Build Summary
          
          ### Build Status
          $(if [ "${{ steps.guix-build.outcome }}" == "success" ]; then
            echo "âœ… **Status**: SUCCESS"
            echo ""
            echo "**Build Output**: \`$BUILD_RESULT\`"
            echo ""
            echo "**Build Size**: $BUILD_SIZE"
          else
            echo "âŒ **Status**: FAILED"
            echo ""
            echo "**Note**: This is expected for complex builds. Check logs for details."
          fi)
          
          ### Performance Metrics
          | Phase | Duration (seconds) |
          |-------|-------------------|
          | Installation | ${INSTALL_DURATION:-0} |
          | Environment Setup | ${SETUP_DURATION:-0} |
          | Syntax Verification | ${VERIFY_DURATION:-0} |
          | Dry-run Validation | ${DRYRUN_DURATION:-0} |
          | Actual Build | ${BUILD_DURATION:-0} |
          | **Total** | **$TOTAL_DURATION** |
          
          ### Build Information
          - **Cache Hit**: ${{ steps.cache-guix.outputs.cache-hit == 'true' && 'âœ“ Yes' || 'âœ— No' }}
          - **Guile Version**: ${GUILE_VERSION:-Not detected}
          - **Derivations to Build**: ${BUILD_COUNT:-N/A}
          - **Items to Download**: ${DOWNLOAD_COUNT:-N/A}
          - **Workflow Run**: #${{ github.run_number }}
          - **Timeout**: 120 minutes
          
          ### Configuration
          - **Caching**: Enabled for user directories
          - **Build Options**: \`--no-grafts --cores=0 --max-jobs=4\`
          - **Verbosity**: Level 1
          EOF

